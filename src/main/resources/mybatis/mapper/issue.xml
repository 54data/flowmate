<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.sailing.flowmate.dao.IssueDao">
	<select id="selectIssueMembers" resultType="Member" parameterType="String">
		SELECT 
		    m.member_id,
		    m.member_name,
		    dept_code.code_name AS member_dept,
		    rank_code.code_name AS member_rank,
		    role_code.code_name AS member_role
		FROM members m
		JOIN common_code dept_code 
		    ON dept_code.code_id = m.member_dept_id
		JOIN common_code rank_code 
		    ON rank_code.code_id = m.member_rank_id
		JOIN common_code role_code 
		    ON role_code.code_id = m.member_role_id
		JOIN project_member pm
		    ON pm.member_id = m.member_id
		WHERE project_id = #{projectId}
		AND role_code.code_name != 'ADMIN'
		AND pm.project_member_enabled = 1
	</select>
	
	<select id="selectIssueNum" resultType="int">
		SELECT issue_seq.NEXTVAL
		FROM dual
	</select>
	
	<select id="selectFmtIssueSeq" parameterType="String" resultType="int">
		SELECT 
			NVL(MAX(TO_NUMBER(SUBSTR(fmt_issue_id, INSTR(fmt_issue_id, '-') + 1))), 0) AS fmt_issue_no 
		FROM issue
		WHERE project_id = #{projectId}
	</select>
	
	<insert id="insertIssue" parameterType="Issue">
		INSERT INTO issue (
			issue_id, project_id, member_id,
			task_id, issue_title, issue_regdate,
			issue_content, fmt_issue_id
		) VALUES (
			#{issueId}, #{projectId}, #{memberId},
			#{taskId}, #{issueTitle}, #{issueRegdate},
			#{issueContent}, #{fmtIssueId}
		)
	</insert>
	
	<select id="selectProjectIssues" parameterType="String">
		SELECT 
			issue_id, project_id, members.member_id,
			members.member_name, task_id, issue_title, 
			issue_regdate, issue_end_date, issue_state, 
			issue_content, fmt_issue_id			
		FROM issue
		JOIN members
			ON issue.member_id = members.member_id
		WHERE project_id = #{projectId}
		AND task_id IS NULL
		AND issue_enabled = 1
		ORDER BY issue_regdate
	</select>
	
	<select id="selectIssueProgress" parameterType="String">
		SELECT 
			ROUND(COUNT(CASE WHEN issue_state = '해결' THEN 1 END) / NULLIF(COUNT(*), 0) * 100, 1) AS issue_progress
		FROM issue
		WHERE project_id = #{projectId}
		AND task_id IS NULL
	</select>
	
	<select id="selectIssueById" parameterType="String">
		SELECT
			member_id, project_id, task_id, 
			issue_title, issue_regdate, issue_state, 
			issue_content, fmt_issue_id	
		FROM issue
		WHERE issue_id = #{issueId}
	</select>
</mapper>