<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.sailing.flowmate.dao.TaskDao">
	
	<insert id="insertTask" parameterType="Task">
		insert into task (
			task_id, project_id, member_id, task_step, task_name, task_priority, 
			task_start_date, task_due_date, task_end_date,task_regdate,
			task_content, task_state, step_start_date, step_due_date, task_log, task_enabled
		)
		values(
			#{taskId},
			#{projectId},
			#{memberId},
			#{taskStep},
			#{taskName},
			#{taskPriority},
			#{taskStartDate},
			#{taskDueDate},
			#{taskEndDate},
			to_char(sysdate, 'yyyymmddhh24miss'),
			#{taskContent},
			#{taskState},
			#{stepStartDate},
			#{stepDueDate},
			#{taskLog},
			#{taskEnabled}
		)
	</insert> 
	
	<insert id="insertTaskAttach" parameterType="Task">	
	    insert into files (
	       file_id, related_id, file_name, file_type, file_data, file_regdate
	    ) values (
	      files_seq.nextval,  #{taskId}, #{fileName}, #{fileType}, #{fileData}, to_char(sysdate, 'yyyymmddhh24miss')
	    )	    
	</insert>
	
	<select id="selectNewNo" resultType="int">
		select task_seq.nextval
		from dual
	</select>
	
	<select id="selectTaskModal" parameterType="String">
	 <![CDATA[
		SELECT DISTINCT
			pjs.step_id, 
			pjs.step_name,  
			TO_CHAR(TO_DATE(pjs.step_start_date, 'YYYYMMDDHH24MISS'), 'YYYY/MM/DD') AS step_start_date,
    			TO_CHAR(TO_DATE(pjs.step_due_date, 'YYYYMMDDHH24MISS'), 'YYYY/MM/DD') AS step_due_date
		FROM 
			PROJECT_STEP pjs
		LEFT JOIN 
			project_member pjm 
		ON 
			pjs.project_id = pjm.project_id
		WHERE 
		    pjs.project_id = #{projectId}
		  AND 
		  	pjs.step_start_date <= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
		  AND 
		  	pjs.step_due_date >= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
		  AND 
		  	step_name not in('완료', '이행')
		  ]]>
	</select>
	
</mapper>