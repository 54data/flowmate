<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.sailing.flowmate.dao.TaskDao">
	
	<insert id="insertTask" parameterType="Task">
		insert into task (
			task_id, project_id, member_id, task_step_Id, task_name, task_priority, 
			task_start_date, task_due_date, task_end_date, task_regdate,
			task_content, task_state, step_start_date, step_due_date, task_log, task_enabled
		)
		values(
			#{taskId},
			#{projectId},
			#{memberId},
			#{taskStepId},
			#{taskName},
			#{taskPriority},
			#{taskStartDate},
			#{taskDueDate},
			#{taskEndDate},		
			to_char(sysdate, 'yyyymmddhh24miss'),
			#{taskContent},
			#{taskState},
			#{stepStartDate},
			#{stepDueDate},
			#{taskLog},
			#{taskEnabled}
		)
	</insert> 
	
	<insert id="insertTaskAttach" parameterType="Task">	
	    insert into files (
	       file_id, related_id, file_name, file_type, file_data, file_regdate
	    ) values (
	      files_seq.nextval,  #{taskId}, #{fileName}, #{fileType}, #{fileData}, to_char(sysdate, 'yyyymmddhh24miss')
	    )	    
	</insert>
	
	<select id="selectNewNo" resultType="int">
		select task_seq.nextval
		from dual
	</select>
	
	<select id="selectTaskModal" parameterType="String">
	 <![CDATA[
		SELECT DISTINCT
			pjs.step_id, 
			pjs.step_name,  
			TO_CHAR(TO_DATE(pjs.step_start_date, 'YYYYMMDDHH24MISS'), 'YYYY/MM/DD') AS step_start_date,
    			TO_CHAR(TO_DATE(pjs.step_due_date, 'YYYYMMDDHH24MISS'), 'YYYY/MM/DD') AS step_due_date
		FROM 
			PROJECT_STEP pjs
		LEFT JOIN 
			project_member pjm 
		ON 
			pjs.project_id = pjm.project_id
		WHERE 
		    pjs.project_id = #{projectId}
		  AND 
			pjs.step_due_date >= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
		  AND 
		  	step_name not in('완료', '이행')
          ORDER BY
            step_start_date
		  ]]>
	</select>
	
	<select id="selectProjTask" parameterType="String">
		SELECT 
			SUBSTR(t.task_id, 8) task_id, 
			t.task_name, 
			pjm.step_name, 
			m.member_name, 
 			TO_CHAR(TO_DATE(t.task_start_date, 'YYYYMMDDHH24MISS'), 'YYYY/MM/DD') task_start_date,
			TO_CHAR(TO_DATE(t.task_due_date, 'YYYYMMDDHH24MISS'), 'YYYY/MM/DD') task_due_date, 
			t.task_priority,
            TO_CHAR(TO_DATE(t.task_regdate, 'YYYYMMDDHH24MISS'), 'YYYY/MM/DD') task_regdate
		FROM 
			task t
		LEFT JOIN 
			members m on t.member_id = m.member_id
        LEFT JOIN 
            project_step pjm on pjm.step_id = t.task_step_id
		WHERE 
			t.project_id = #{projectId}
		ORDER BY 
            SUBSTR(t.task_id, 13)
	</select>
	
	<select id="selectTaskMembers" parameterType="String">
		SELECT 
		    m.member_id AS member_id,
		    m.member_name As ,
		    dept_code.code_name AS memberDept,
		    rank_code.code_name AS memberRank,
		    role_code.code_name AS memberRole,
		    pjm.project_id, 
		    pjm.member_id AS project_member_id
		FROM 
			members m
		JOIN 
			common_code dept_code 
		    ON dept_code.code_id = m.member_dept_id
		JOIN 
			common_code rank_code 
		    ON rank_code.code_id = m.member_rank_id
		JOIN 
			common_code role_code 
		    ON role_code.code_id = m.member_role_id
		JOIN 
			project_member pjm
		    ON pjm.member_id = m.member_id
		WHERE 
			project_id = #{projectId}
		AND role_code.code_name != 'ADMIN'
	</select>
	
</mapper>